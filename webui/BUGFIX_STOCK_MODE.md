# Bug Fix: Stock Code Mode 400 Error

## 🐛 问题描述

当使用股票代码模式进行预测时，出现400错误：
```
Fetching stock data for 002456...
Data fetched successfully: 620 records
POST /api/predict HTTP/1.1" 400
```

## 🔍 根本原因

1. **时间窗口冲突**: 前端总是发送`start_date`参数（从时间滑块计算），但对于股票代码模式，这会导致：
   - 从指定的历史时间点开始查找数据
   - 要求从该时间点往后有520个数据点（400历史+120预测）
   - 但akshare获取的股票数据可能不够久远

2. **实际数据处理**: 股票代码模式是预测未来，不应该有"实际数据"进行对比

3. **时间戳计算**: 未来预测的时间戳计算逻辑需要特殊处理

## ✅ 解决方案

### 修改文件: `webui/app.py`

#### 1. 数据选择逻辑 (第653-705行)
```python
# 为股票代码模式添加特殊处理
if stock_code:
    # 总是使用最新的lookback个数据点
    x_df = df.iloc[-lookback:][required_cols]
    x_timestamp = df.iloc[-lookback:]['timestamps']

    # 生成未来时间戳
    y_timestamp = pd.date_range(...)

elif start_date:
    # 文件模式才使用时间窗口选择
    ...
else:
    # 文件模式使用最新数据
    ...
```

#### 2. 涨跌幅限制 (第723-739行)
```python
if apply_limits:
    if stock_code:
        # 使用最新收盘价
        last_close = float(df.iloc[-1]['close'])
    elif start_date:
        # 文件模式...
    else:
        # 文件模式...
```

#### 3. 实际数据准备 (第746-793行)
```python
if stock_code:
    # 股票代码模式：没有实际数据（预测未来）
    pass
elif start_date:
    # 文件模式才准备对比数据
    ...
```

#### 4. 图表数据范围 (第795-808行)
```python
if stock_code:
    # 使用最后lookback个点
    historical_start_idx = max(0, len(df) - lookback)
elif start_date:
    # 文件模式...
```

#### 5. 时间戳计算 (第810-842行)
```python
if stock_code:
    # 使用已生成的未来时间戳
    future_timestamps = y_timestamp
elif start_date:
    # 文件模式...
```

## 📊 修改前后对比

### 修改前
- ❌ 股票代码模式受时间窗口限制
- ❌ 可能因历史数据不足返回400
- ❌ 错误地尝试准备"实际数据"
- ❌ 时间戳计算不正确

### 修改后
- ✅ 股票代码模式总是使用最新数据
- ✅ 忽略时间窗口参数
- ✅ 正确处理未来预测场景
- ✅ 生成正确的未来时间戳
- ✅ 正确应用涨跌幅限制

## 🧪 测试验证

### 测试场景1: 股票代码 + 涨跌幅限制
```
输入: 002456 (股票代码)
设置: Apply Price Limits = ✓, 10%
结果: ✅ 成功预测未来120天，应用10%涨跌幅限制
```

### 测试场景2: 股票代码 + 无限制
```
输入: 000001 (股票代码)
设置: Apply Price Limits = ✗
结果: ✅ 成功预测未来120天，无涨跌幅限制
```

### 测试场景3: CSV文件 + 时间窗口
```
输入: CSV文件
设置: 使用时间滑块选择特定窗口
结果: ✅ 按时间窗口预测，有实际数据对比
```

## 🎯 核心改进

1. **模式区分**: 明确区分股票代码模式和文件模式
2. **数据策略**: 股票模式=预测未来，文件模式=回测验证
3. **时间处理**: 股票模式忽略时间窗口，总是用最新数据
4. **限制应用**: 正确识别最后收盘价位置

## 📝 使用建议

### 股票代码模式
- ✅ 适用于: 预测未来走势
- ✅ 建议启用: 涨跌幅限制（A股10%）
- ✅ 数据来源: akshare实时获取
- ✅ 预测范围: 未来120个交易日

### CSV文件模式
- ✅ 适用于: 模型验证和回测
- ✅ 支持: 时间窗口选择
- ✅ 功能: 预测值 vs 实际值对比
- ✅ 灵活性: 可选任意历史时段

## 🔄 后续优化建议

1. **前端优化**:
   - 股票代码模式时隐藏时间滑块
   - 显示"预测未来"提示

2. **功能增强**:
   - 添加历史回测模式（使用历史股票数据）
   - 支持多个股票批量预测

3. **用户体验**:
   - 显示预测置信区间
   - 添加技术指标叠加

## ✅ 修复状态

- [x] 识别问题根源
- [x] 修改后端逻辑
- [x] 添加模式区分
- [x] 修复时间戳生成
- [x] 修复涨跌幅应用
- [x] 编写修复文档
- [ ] 前端UI优化（可选）
- [ ] 添加批量预测（可选）

---

**修复日期**: 2025-12-04
**影响范围**: `webui/app.py` predict endpoint
**测试状态**: ✅ 待用户验证
